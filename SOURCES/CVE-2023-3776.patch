From 1779f5567bae7c0e7ab4508aa0a2be04be035e62 Mon Sep 17 00:00:00 2001
From: Joe Lawrence <joe.lawrence@redhat.com>
Date: Tue, 29 Aug 2023 16:42:05 -0400
Subject: [KPATCH CVE-2023-3776] kpatch fixes for CVE-2023-3776

Kernels:
5.14.0-284.11.1.el9_2
5.14.0-284.18.1.el9_2
5.14.0-284.25.1.el9_2


Kpatch-MR: https://gitlab.com/redhat/prdsc/rhel/src/kpatch/rhel-9/-/merge_requests/50
Approved-by: Yannick Cote (@ycote1)
Changes since last build:
arches: x86_64 ppc64le
cls_fw.o: changed function: fw_set_parms
nf_tables_api.o: changed function: nf_tables_newrule
nf_tables_api.o: changed function: nft_chain_lookup_byid
nf_tables_api.o: changed function: nft_verdict_init
nft_byteorder.o: changed function: nft_byteorder_eval
nft_set_pipapo.o: changed function: nft_pipapo_remove
---------------------------

Modifications: none

commit 8ceb3cd379fee49cdfa67799900c10464ed2341f
Author: Davide Caratti <dcaratti@redhat.com>
Date:   Tue Aug 1 11:43:38 2023 +0200

    net/sched: cls_fw: Fix improper refcount update leads to use-after-free

    Bugzilla: https://bugzilla.redhat.com/2225642
    CVE: CVE-2023-3776
    Y-Commit: ba1d4dd15d004f3a72e8e9ef9bc7f696dc37d366

    O-Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2225102
    O-CVE: CVE-2023-3776
    Upstream Status: net.git commit 0323bce598ee

    commit 0323bce598eea038714f941ce2b22541c46d488f
    Author: M A Ramdhan <ramdhan@starlabs.sg>
    Date:   Wed Jul 5 12:15:30 2023 -0400

        net/sched: cls_fw: Fix improper refcount update leads to use-after-free

        In the event of a failure in tcf_change_indev(), fw_set_parms() will
        immediately return an error after incrementing or decrementing
        reference counter in tcf_bind_filter().  If attacker can control
        reference counter to zero and make reference freed, leading to
        use after free.

        In order to prevent this, move the point of possible failure above the
        point where the TC_FW_CLASSID is handled.

        Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
        Reported-by: M A Ramdhan <ramdhan@starlabs.sg>
        Signed-off-by: M A Ramdhan <ramdhan@starlabs.sg>
        Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
        Reviewed-by: Pedro Tammela <pctammela@mojatatu.com>
        Message-ID: <20230705161530.52003-1-ramdhan@starlabs.sg>
        Signed-off-by: Jakub Kicinski <kuba@kernel.org>

    Signed-off-by: Davide Caratti <dcaratti@redhat.com>
    (cherry picked from commit 1f4feed3d11f14eb40b0bb8d74315e94b5ff1e1c)
    Signed-off-by: Herton R. Krzesinski <herton@redhat.com>

Signed-off-by: Joe Lawrence <joe.lawrence@redhat.com>
---
 net/sched/cls_fw.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/net/sched/cls_fw.c b/net/sched/cls_fw.c
index 8654b0ce997c..ea52c320f67c 100644
--- a/net/sched/cls_fw.c
+++ b/net/sched/cls_fw.c
@@ -210,11 +210,6 @@ static int fw_set_parms(struct net *net, struct tcf_proto *tp,
 	if (err < 0)
 		return err;
 
-	if (tb[TCA_FW_CLASSID]) {
-		f->res.classid = nla_get_u32(tb[TCA_FW_CLASSID]);
-		tcf_bind_filter(tp, &f->res, base);
-	}
-
 	if (tb[TCA_FW_INDEV]) {
 		int ret;
 		ret = tcf_change_indev(net, tb[TCA_FW_INDEV], extack);
@@ -231,6 +226,11 @@ static int fw_set_parms(struct net *net, struct tcf_proto *tp,
 	} else if (head->mask != 0xFFFFFFFF)
 		return err;
 
+	if (tb[TCA_FW_CLASSID]) {
+		f->res.classid = nla_get_u32(tb[TCA_FW_CLASSID]);
+		tcf_bind_filter(tp, &f->res, base);
+	}
+
 	return 0;
 }
 
-- 
2.40.1


